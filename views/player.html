<video id='video' autoplay></video>
<script>
    if (document.querySelector('div.plyr')) document.querySelector('div.plyr').remove();
    if (document.querySelector('#video').canPlayType("application/vnd.apple.mpegurl")) {
        document.querySelector('#video').src = "{{ . }}";
    } else if (Hls.isSupported()) {
        const hls = new Hls();
        hls.loadSource("{{ . }}");
        hls.on(Hls.Events.MANIFEST_PARSED, () => {
            const availableQualities = hls.levels.map(level => level.height)
            new Plyr(document.querySelector('#video'), {
                keyboard: {
                    focused: true,
                    global: true,
                },
                speed: {
                    selected: 1,
                    options: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2],
                },
                controls: [
                    "play-large",
                    "restart",
                    "rewind",
                    "play",
                    "fast-forward",
                    "progress",
                    "current-time",
                    "duration",
                    "mute",
                    "volume",
                    "settings",
                    "fullscreen",
                ],
                quality: {
                    default: availableQualities[0],
                    options: availableQualities,
                    forced: true,
                    onChange: (quality) => {
                        window.hls.levels.forEach((level, levelIndex) => {
                            if (level.height === quality) window.hls.currentLevel = levelIndex
                        })
                    }
                }
            });
        });
        hls.attachMedia(document.querySelector('#video'));
        window.hls = hls;
    }
</script>
